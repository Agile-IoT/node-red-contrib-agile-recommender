<script type="text/javascript">
   //Declaration of variables
   var intervalFunction;
   var apiEndpoint;
   var tabs = ['getCloudRecommendation', 'getWorkflowRecommendation'];
   var keys = ['title','description','href']
   var contentData = new Array();

   //Icon settings for the recommender tabs
   var iconRatio = 15;
   var iconHeight = window.innerHeight/iconRatio;
   var iconWidth = window.innerWidth/iconRatio;

   //Icon URLs
   var CloudUrl = 'https://s26.postimg.org/w8qdsru11/cloud.png';
   var nodeUrl = 'https://s26.postimg.org/lkmmtxk1x/node.png';
   var flowUrl = 'https://s26.postimg.org/r7izremkl/workflow.png';

   //Log variable for logging on the browser window
   var log = function() {
   if(localStorage.debug)
   console.log.apply(console.log, arguments);
   }

   log(window.getHeight+' then '+window.getWidth+ 'then '+iconHeight+'then '+iconWidth)

   //Create div elements for the tabs and store in contentData
  tabs.forEach(function(tab){
     temp = $('<div/>', {'id': tab});
     contentData.push(temp)
  })
   //Setup endpoint link
   var protocol = document.location.protocol || "http:";
   var host = document.location.hostname;
   apiEndpoint = protocol + "//" + host + ':8090'+'/recommenderdockerservice/';
   log(apiEndpoint)

   //Function to update the tabs, takes the types of recommender for each tab as input and sets the content of the tab
  var updateData = function(types){
    types.forEach(function(type){
       var tabname = '#'+type;
       $.ajax({
       type: "GET",
       dataType: 'json',
       url: apiEndpoint+type,
       crossDomain : true
       })
       .done(function(data) {
          var dataString = "";
            for (var typeKey in data)
              {
                data[typeKey].forEach(function (datavalue){
                  if(datavalue['type'])
                  {
                    dataString = dataString + '<img src="'+window[datavalue['type']+"Url"]+'"align="left" height="'+iconHeight+'" width ="'+iconWidth+'">';
                  }
                  else
                    dataString = dataString + '<img src="'+window[type.replace("get","").replace("Recommendation","")+"Url"]+'"align="left" height="'+iconHeight+'" width ="'+iconWidth+'">';
                  for(key in datavalue)
                  {
                    dataString = dataString+'<p><b> '+key+': </b>'+datavalue[key]+'</p>'
                  }
                  dataString = dataString + '<hr style="border: 1px dashed black;" />'
                })
              }
            $(tabname).html('<div class="recommender-tab-content">'+dataString+'</div>');
       })
       .fail( function(xhr, textStatus, errorThrown) {
          log("Called with "+tabname)
          $(tabname).html('<div class="recommender-tab-content">'+"Failed to retrieve information from the recommender type: "+type+'</div>');
      })
    });
    }

  //Register the recommender node
   RED.nodes.registerType('recommender',{
        category: "agile",
        paletteLabel: "Recommender",
        label: "Recommender",
        color: "#C7E9C0",
        icon: "inject.png",
        onpaletteadd: function(){
           tabs.forEach(function(tab){
             RED.sidebar.addTab({
                    id: tab,
                    label: tab.replace("get","").replace("Recommendation",""),
                    name: tab,
                    content: contentData[tabs.indexOf(tab)],
                    closeable: true,
                    disableOnEdit: true,
                    onchange: function() {
                       log("Content changed");
                        }
                });
                $('#'+tab).html('<div class="recommender-tab-content">'+"Please wait until recommender output is updated"+'</div>');
          })


           },
         onpaletteremove:function(){
            RED.sidebar.removeTab('recommender');
            clearInterval(intervalFunction);
         }
          });
         //update the data in this interval
         intervalFunction = setInterval(function(){updateData(tabs)},5000);


</script>

<script type="text/x-red" data-template-name="recommender">
    <div class="form-row">
        <label for="recommender-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="recommender-name" placeholder="Name">
    </div>
    <div class="form-tips"><b>Tip:</b> This is here to help.</div>
</script>


<script type="text/x-red" data-help-name="recommender">
   <p>Add and update recommender sidetab</p>
   <p>This node is included in the palette for the sole purpose of adding the sidebar tab for the AGILE recommender and configurator engine. This node updates the contents of the sidebar tab every 5 minutes</p>
   </script>
