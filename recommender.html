<script type="text/javascript">
   //Declaration of variables

   var log = function() {
   if(localStorage.debug)
   console.log.apply(console.log, arguments);
   }

   var intervalFunction;
   var apiEndpoint;
   var tabs = ['getCloudRecommendation', 'getWorkflowRecommendation']
   var contentData = new Array()

   tabs.forEach(function(tab){
      temp = $('<div/>', {'id': tab});
      contentData.push(temp)
   })

   var http = document.location.protocol || "http:";
   var host = document.location.hostname;
   apiEndpoint = http + "//" + host + ':8090'+'/recommenderdockerservice/';
   log(apiEndpoint)


    var updateData = function(types){
      types.forEach(function(type){
         var tabname = '#'+type;
         $.ajax({
         type: "GET",
         dataType: 'json',
         url: apiEndpoint+type,
         crossDomain : true
         })
         .done(function( data ) {
            var dataString = "";
            for (var i = 0; i<data.appList.length; i++)
              {
                 dataString = dataString+'<p><b> title: '+data.appList[i].title+'</b></p><p>href: '+data.appList[i].href+'</p><p> stars: '+data.appList[i].stars+'</p><p> downloads:' +data.appList[i].downloads+'</p>'
              }
            $(tabname).html('<div class="enebular-admin-wrapper">'+dataString+'</div>');
         })
         .fail( function(xhr, textStatus, errorThrown) {
            log("Called with "+tabname)
            $(tabname).html('<div class="enebular-admin-wrapper">'+"Failed to retrieve information from the recommender type: "+type+'</div>');
        })
      });
      }

   RED.nodes.registerType('recommender',{
        category: "agile",
        paletteLabel: "Recommender",
        label: "Recommender",
        color: "#C7E9C0",
        icon: "inject.png",
        onpaletteadd: function(){
           tabs.forEach(function(tab){
             RED.sidebar.addTab({
                    id: tab,
                    label: tab.replace("get",""),
                    name: tab,
                    content: contentData[tabs.indexOf(tab)],
                    closeable: true,
                    disableOnEdit: true,
                    onchange: function() {
                       log("Content changed");
                        }
                });
                $('#'+tab).html('<div class="enebular-admin-wrapper">'+"Please wait until recommender output is updated"+'</div>');
          })


           },
         onpaletteremove:function(){
            RED.sidebar.removeTab('recommender');
            clearInterval(intervalFunction);
         }
          });

         intervalFunction = setInterval(function(){updateData(tabs)},5000);


</script>

<script type="text/x-red" data-template-name="recommender">
    <div class="form-row">
        <label for="recommender-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="recommender-name" placeholder="Name">
    </div>
    <div class="form-tips"><b>Tip:</b> This is here to help.</div>
</script>


<script type="text/x-red" data-help-name="recommender">
   <p>Add and update recommender sidetab</p>
   <p>This node is included in the palette for the sole purpose of adding the sidebar tab for the AGILE recommender and configurator engine. This node updates the contents of the sidebar tab every 5 minutes</p>
   </script>
